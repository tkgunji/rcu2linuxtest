<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RCU linux tools and drivers for the DCS board : sendRCUcommand.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<h1>sendRCUcommand.c</h1><a href="sendRCUcommand_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// $Id: sendRCUcommand.c,v 1.20 2007/03/17 00:01:16 richter Exp $</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="comment">/************************************************************************</span>
<a name="l00004"></a>00004 <span class="comment">**</span>
<a name="l00005"></a>00005 <span class="comment">**</span>
<a name="l00006"></a>00006 <span class="comment">** This file is property of and copyright by the Experimental Nuclear </span>
<a name="l00007"></a>00007 <span class="comment">** Physics Group, Dep. of Physics and Technology</span>
<a name="l00008"></a>00008 <span class="comment">** University of Bergen, Norway, 2004</span>
<a name="l00009"></a>00009 <span class="comment">** This file has been written by Matthias Richter,</span>
<a name="l00010"></a>00010 <span class="comment">** Matthias.Richter@ift.uib.no</span>
<a name="l00011"></a>00011 <span class="comment">**</span>
<a name="l00012"></a>00012 <span class="comment">** Permission to use, copy, modify and distribute this software and its  </span>
<a name="l00013"></a>00013 <span class="comment">** documentation strictly for non-commercial purposes is hereby granted  </span>
<a name="l00014"></a>00014 <span class="comment">** without fee, provided that the above copyright notice appears in all  </span>
<a name="l00015"></a>00015 <span class="comment">** copies and that both the copyright notice and this permission notice  </span>
<a name="l00016"></a>00016 <span class="comment">** appear in the supporting documentation. The authors make no claims    </span>
<a name="l00017"></a>00017 <span class="comment">** about the suitability of this software for any purpose. It is         </span>
<a name="l00018"></a>00018 <span class="comment">** provided "as is" without express or implied warranty.                 </span>
<a name="l00019"></a>00019 <span class="comment">**</span>
<a name="l00020"></a>00020 <span class="comment">*************************************************************************/</span>
<a name="l00021"></a>00021 
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include "<a class="code" href="memoryguard_8h.html">memoryguard.h</a>"</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;linux/errno.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00040"></a>00040 <span class="comment">//#include &lt;sys/types.h&gt;</span>
<a name="l00041"></a>00041 <span class="comment">//#include &lt;sys/stat.h&gt;</span>
<a name="l00042"></a>00042 <span class="comment">//#include &lt;fcntl.h&gt;</span>
<a name="l00043"></a>00043 <span class="comment">//#include &lt;unistd.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include "<a class="code" href="cmdInterpreter_8h.html">cmdInterpreter.h</a>"</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include "<a class="code" href="dcscMsgBufferInterface_8h.html">dcscMsgBufferInterface.h</a>"</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include "<a class="code" href="selectmapInterface_8h.html">selectmapInterface.h</a>"</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include "<a class="code" href="mrtimers_8h.html">mrtimers.h</a>"</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include "<a class="code" href="mrshellprim_8h.html">mrshellprim.h</a>"</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="sendRCUcommand_8c.html#ff659880ee30289b3cfb7c93bc73e726">00051</a> <span class="preprocessor">#define ENABLE_GETLINE</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span><span class="preprocessor">#ifdef ENABLE_GETLINE</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span><span class="keywordtype">char</span> *<a class="code" href="Getline_8c.html#d4f9d54d023bc30cc8f3e721d81ce386">Getline</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *prompt); <span class="comment">// Getline.c</span>
<a name="l00054"></a>00054 <span class="keywordtype">void</span> <a class="code" href="Getline_8c.html#5bc9732aae5850cd5a7b8c7886f3384f">Gl_histadd</a>(<span class="keywordtype">char</span> *buf); <span class="comment">// Getline.c</span>
<a name="l00055"></a>00055 <span class="preprocessor">#endif // ENABLE_GETLINE</span>
<a name="l00056"></a><a class="code" href="sendRCUcommand_8c.html#7d71767838ad691171592b8bf69624ad">00056</a> <span class="preprocessor"></span><span class="preprocessor">#define promt "enter operation (h/i/q/r/w):"</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="comment">/***************************************************************************************</span>
<a name="l00060"></a>00060 <span class="comment"> * signal handler</span>
<a name="l00061"></a>00061 <span class="comment"> */</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 
<a name="l00064"></a><a class="code" href="sendRCUcommand_8c.html#47cf995bed43c4e6bc563073f5b8f607">00064</a> <span class="keywordtype">void</span> <a class="code" href="sendRCUcommand_8c.html#47cf995bed43c4e6bc563073f5b8f607">sigquitHandler</a>(<span class="keywordtype">int</span> param) {
<a name="l00065"></a>00065   <span class="keywordflow">if</span> (<a class="code" href="cmdInterpreter_8c.html#ae37490e691f5b4d2c2e8f22713555da">terminateBatchProcessing</a>()&lt;=0)
<a name="l00066"></a>00066     <span class="comment">// no batch processing active, restore the default</span>
<a name="l00067"></a>00067     signal(SIGINT, SIG_DFL);
<a name="l00068"></a>00068   <span class="keywordflow">else</span> {
<a name="l00069"></a>00069   }
<a name="l00070"></a>00070 }
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mrshellprim_8c.html#34fcfc606a53070425a87fce190ee38d">g_mrShellPrimDbg</a>;
<a name="l00073"></a>00073 
<a name="l00074"></a><a class="code" href="sendRCUcommand_8c.html#8481f9823ab837a716b4294324fd3def">00074</a> <a class="code" href="structFctMode__t.html">TFctMode</a> <a class="code" href="sendRCUcommand_8c.html#8481f9823ab837a716b4294324fd3def">scanModeNoError</a> = {<a class="code" href="mrshellprim_8h.html#44108151eef216f1bbe017e9e1503c50">SCANMODE_SILENT</a>|<a class="code" href="mrshellprim_8h.html#3c911f1397ec09fbcc6a1feac53be850">SCANMODE_FORCE_TERMINATION</a>, NULL, NULL};
<a name="l00075"></a><a class="code" href="sendRCUcommand_8c.html#bae7cc25bf2667a9438fbb8ca696ae75">00075</a> <a class="code" href="structFctMode__t.html">TFctMode</a> <a class="code" href="sendRCUcommand_8c.html#bae7cc25bf2667a9438fbb8ca696ae75">scanModeMainOptions</a> = {<a class="code" href="mrshellprim_8h.html#3c911f1397ec09fbcc6a1feac53be850">SCANMODE_FORCE_TERMINATION</a>|<a class="code" href="mrshellprim_8h.html#b41f1fbe57be88462133d6065f48a9f9">SCANMODE_READ_ONE_CMD</a>|<a class="code" href="mrshellprim_8h.html#222a83d015679c34e763bc9f7d9778c5">SCANMODE_PERSISTENT</a>, NULL, NULL};
<a name="l00076"></a><a class="code" href="sendRCUcommand_8c.html#260fedd682f84c2bf63d9fbcf7a85a84">00076</a> <a class="code" href="structFctMode__t.html">TFctMode</a> <a class="code" href="sendRCUcommand_8c.html#260fedd682f84c2bf63d9fbcf7a85a84">scanModeShellArgs</a> = {<a class="code" href="mrshellprim_8h.html#3c911f1397ec09fbcc6a1feac53be850">SCANMODE_FORCE_TERMINATION</a>, <span class="stringliteral">" "</span>, NULL};
<a name="l00077"></a>00077 
<a name="l00078"></a><a class="code" href="sendRCUcommand_8c.html#c5dd9bf9adc293400bcf4c9746e1624d">00078</a> <a class="code" href="structArgDef__t.html">TArgDef</a> <a class="code" href="sendRCUcommand_8c.html#c5dd9bf9adc293400bcf4c9746e1624d">shellArgs</a>[] = {
<a name="l00079"></a>00079   {<span class="stringliteral">"h"</span>,<span class="stringliteral">"help"</span>,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b3693da28770e1bd5abcff3bfab36328f85">eFctNoArg</a>, {(<span class="keywordtype">void</span>*)<a class="code" href="cmdInterpreter_8c.html#f03f7609a66def2e7fae02a477c38d97">printHelp</a>}},{NULL},<a class="code" href="mrshellprim_8h.html#6ec4b88030cc16c92c86aa9fcd1789ee">ARGDEF_UNTERM_SHORT</a>},
<a name="l00080"></a>00080   {<span class="stringliteral">"info"</span>,<span class="stringliteral">"i"</span>,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b3693da28770e1bd5abcff3bfab36328f85">eFctNoArg</a>, {(<span class="keywordtype">void</span>*)<a class="code" href="cmdInterpreter_8c.html#ac3ae2fb745e63e33060d5c0b658f745">printInfo</a>}},{NULL},<a class="code" href="mrshellprim_8h.html#6ec4b88030cc16c92c86aa9fcd1789ee">ARGDEF_UNTERM_SHORT</a>},
<a name="l00081"></a>00081   {<span class="stringliteral">""</span>,<span class="stringliteral">""</span>,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b36a94b1781ada88507c56c4475f25fa92f">eUnknownType</a>, {NULL}},{NULL},0},
<a name="l00082"></a>00082 };
<a name="l00083"></a>00083 
<a name="l00084"></a><a class="code" href="sendRCUcommand_8c.html#3f74ad6fcd7825c54ac293c30f5c84dc">00084</a> <a class="code" href="structArgDef__t.html">TArgDef</a> <a class="code" href="sendRCUcommand_8c.html#3f74ad6fcd7825c54ac293c30f5c84dc">mainOptions</a>[] = {
<a name="l00085"></a>00085   {<span class="stringliteral">"-d"</span>,<span class="stringliteral">"--device="</span>,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b369bf242e7bb183d9518928958c83c9a22">eConstString</a>, {NULL}},{NULL},<a class="code" href="mrshellprim_8h.html#9ecb4288871a72cb5f4cb8428498de9c">ARGDEF_UNTERM_LONG</a>},
<a name="l00086"></a>00086   {<span class="stringliteral">"-e"</span>,<span class="stringliteral">"--encode"</span>,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b365461a9e2704387e11258e14a0b41ac1a">eBool</a>, {NULL}},{NULL},0},
<a name="l00087"></a>00087   {<span class="stringliteral">"-a"</span>,<span class="stringliteral">"--append"</span>,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b365461a9e2704387e11258e14a0b41ac1a">eBool</a>, {NULL}},{NULL},0},
<a name="l00088"></a>00088   {<span class="stringliteral">"-v"</span>,<span class="stringliteral">"--verbosity"</span>,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b36dd647739976fe8f17c25e3fe04d30eeb">eInteger</a>, {NULL}},{NULL},0},
<a name="l00089"></a>00089   {NULL,<span class="stringliteral">"--debug"</span>,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b36a64d04be3dc94180a329fac904a5d239">eHex</a>, {NULL}},{NULL},0},
<a name="l00090"></a>00090   {NULL,<span class="stringliteral">"--mibsize"</span>,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b36a64d04be3dc94180a329fac904a5d239">eHex</a>, {NULL}},{NULL},0},
<a name="l00091"></a>00091   {<span class="stringliteral">"-mmgv"</span>,<span class="stringliteral">"--memory-guard-verbosity"</span>,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b36dd647739976fe8f17c25e3fe04d30eeb">eInteger</a>, {NULL}},{NULL},0},
<a name="l00092"></a>00092   {<span class="stringliteral">"-mmgf"</span>,<span class="stringliteral">"--memory-guard-logfile"</span>,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b369bf242e7bb183d9518928958c83c9a22">eConstString</a>, {NULL}},{NULL},0},
<a name="l00093"></a>00093   {<span class="stringliteral">"-h"</span>,<span class="stringliteral">"--help"</span>,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b3693da28770e1bd5abcff3bfab36328f85">eFctNoArg</a>, {(<span class="keywordtype">void</span>*)<a class="code" href="cmdInterpreter_8c.html#f03f7609a66def2e7fae02a477c38d97">printHelp</a>}},{NULL},<a class="code" href="mrshellprim_8h.html#ba7cfe65a42313488b4cfdf335409d39">ARGDEF_TERMINATE</a>},
<a name="l00094"></a>00094   {<span class="stringliteral">"-i"</span>,<span class="stringliteral">"--info"</span>,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b3693da28770e1bd5abcff3bfab36328f85">eFctNoArg</a>, {(<span class="keywordtype">void</span>*)<a class="code" href="cmdInterpreter_8c.html#ac3ae2fb745e63e33060d5c0b658f745">printInfo</a>}},{NULL},<a class="code" href="mrshellprim_8h.html#ba7cfe65a42313488b4cfdf335409d39">ARGDEF_TERMINATE</a>},
<a name="l00095"></a>00095   {<span class="stringliteral">""</span>,<span class="stringliteral">""</span>,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b36a94b1781ada88507c56c4475f25fa92f">eUnknownType</a>, {NULL}},{NULL},0},
<a name="l00096"></a>00096 };
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="sendRCUcommand_8c.html#641307208f220bf55de2578828522acd">00098</a> <a class="code" href="structArgDef__t.html">TArgDef</a> <a class="code" href="sendRCUcommand_8c.html#641307208f220bf55de2578828522acd">mainArgs</a>[] = {
<a name="l00099"></a>00099   {<span class="stringliteral">"--mrsdbg"</span>,NULL,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b36be303c42da892f2d0101b668e8aa252a">eHexArray</a>, {(<span class="keywordtype">void</span>*)&amp;<a class="code" href="mrshellprim_8c.html#34fcfc606a53070425a87fce190ee38d">g_mrShellPrimDbg</a>}},{(<span class="keywordtype">void</span>*)1},0},
<a name="l00100"></a>00100   {<span class="stringliteral">"--mrshelp"</span>,NULL,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b3693da28770e1bd5abcff3bfab36328f85">eFctNoArg</a>, {(<span class="keywordtype">void</span>*)<a class="code" href="mrshellprim_8c.html#20b23f294fae687b7b0ad7c6483ec564">mrShellPrimPrintDbgFlags</a>}},{(<span class="keywordtype">void</span>*)1},<a class="code" href="mrshellprim_8h.html#ba7cfe65a42313488b4cfdf335409d39">ARGDEF_TERMINATE</a>},
<a name="l00101"></a>00101   {<span class="stringliteral">"-*"</span>,<span class="stringliteral">"--*"</span>,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b364c15eefaf9247f7b503ae586294be587">eFctInclusive</a>, {(<span class="keywordtype">void</span>*)<a class="code" href="sendRCUcommand_8c.html#3f74ad6fcd7825c54ac293c30f5c84dc">mainOptions</a>}},{(<span class="keywordtype">void</span>*)&amp;<a class="code" href="sendRCUcommand_8c.html#bae7cc25bf2667a9438fbb8ca696ae75">scanModeMainOptions</a>},0},
<a name="l00102"></a>00102   {NULL,NULL,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b365461a9e2704387e11258e14a0b41ac1a">eBool</a>, {NULL}},{NULL},<a class="code" href="mrshellprim_8h.html#fc218ec9b386341226b551419f3f624c">ARGDEF_BREAK</a>},
<a name="l00103"></a>00103   {<span class="stringliteral">""</span>,<span class="stringliteral">""</span>,{<a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b36a94b1781ada88507c56c4475f25fa92f">eUnknownType</a>, {NULL}},{NULL},0},
<a name="l00104"></a>00104 };
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 
<a name="l00107"></a><a class="code" href="sendRCUcommand_8c.html#22ebaf74d5c7bacab58b44ae963c85d6">00107</a> <span class="keywordtype">int</span> <a class="code" href="bitswapper_8c.html#3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** arg) 
<a name="l00108"></a>00108 {
<a name="l00109"></a>00109 
<a name="l00110"></a>00110   printf(<span class="stringliteral">"execute rcu-sh\n"</span>);
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 
<a name="l00113"></a>00113   <span class="keywordtype">int</span> iResult=0;
<a name="l00114"></a>00114   <span class="keywordtype">char</span> cmdBuffer[100]=<span class="stringliteral">"i"</span>;
<a name="l00115"></a>00115   <span class="keywordtype">char</span> queryBuffer[100]=<span class="stringliteral">"i"</span>;
<a name="l00116"></a>00116   <span class="keyword">const</span> <span class="keywordtype">char</span>* pDevice=NULL; <span class="comment">// by default the dcscRCUacces choose /dev/dcsc if this parameter is NULL</span>
<a name="l00117"></a>00117   <span class="keywordtype">int</span> iPos=0;
<a name="l00118"></a>00118   <span class="keywordtype">int</span> iArg=1;
<a name="l00119"></a>00119   <span class="keywordflow">if</span> (argc-iArg&gt;0)
<a name="l00120"></a>00120     iResult=<a class="code" href="mrshellprim_8c.html#e2735ecedc52b1199ecf8a208339c072">ScanArguments</a>((<span class="keyword">const</span> <span class="keywordtype">char</span>**)arg+iArg, argc-iArg, 0, <a class="code" href="sendRCUcommand_8c.html#641307208f220bf55de2578828522acd">mainArgs</a>, &amp;<a class="code" href="sendRCUcommand_8c.html#8481f9823ab837a716b4294324fd3def">scanModeNoError</a>);
<a name="l00121"></a>00121   <span class="keywordflow">if</span> (iResult&gt;=0) {
<a name="l00122"></a>00122     <span class="keywordtype">int</span> iArgShift=(iResult&amp;<a class="code" href="mrshellprim_8h.html#26c19cdba298002712c08c9964edd0df">SCANRET_MASK_PROCESSED_ARGS</a>)&gt;&gt;<a class="code" href="mrshellprim_8h.html#8c595e09c68cb8c5ca0ce78002f48caf">SCANRET_BITSHIFT_PROCESSED_ARGS</a>;
<a name="l00123"></a>00123     iArg+=iArgShift;
<a name="l00124"></a>00124     iPos+=(iResult&amp;<a class="code" href="mrshellprim_8h.html#b17dfbdaa414a0479199510989ed3daf">SCANRET_MASK_OFFSET_LAST_ARG</a>)&gt;&gt;<a class="code" href="mrshellprim_8h.html#720b462066770425625df7cbf09e2274">SCANRET_BITSHIFT_OFFSET_LAST_ARG</a>;
<a name="l00125"></a>00125     <span class="keywordflow">if</span> (iArg&lt;argc &amp;&amp; arg[iArg]!=NULL &amp;&amp; <span class="keyword">sizeof</span>(arg[iArg])&lt;=iPos) {
<a name="l00126"></a>00126       iArg++;
<a name="l00127"></a>00127       iPos=0;
<a name="l00128"></a>00128     }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130   <span class="comment">/*     pDevice=mainOptions[0].data.pString; */</span>
<a name="l00131"></a>00131   <span class="comment">/*     iResult=initRcuAccess(pDevice); */</span>
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 
<a name="l00134"></a>00134     <span class="keywordflow">if</span> (<a class="code" href="mrshellprim_8c.html#aa038cf5a29f51145c876af7fb5271d3">mrShellPrimGetData</a>(<a class="code" href="sendRCUcommand_8c.html#3f74ad6fcd7825c54ac293c30f5c84dc">mainOptions</a>, <span class="stringliteral">"-d"</span>, (<span class="keywordtype">void</span>**)&amp;pDevice, <a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b369bf242e7bb183d9518928958c83c9a22">eConstString</a>)&lt;0) pDevice=NULL;
<a name="l00135"></a>00135     <a class="code" href="structdcscInitArguments__t.html">TdcscInitArguments</a> dcscArgs;
<a name="l00136"></a>00136     memset(&amp;dcscArgs, 0, <span class="keyword">sizeof</span>(<a class="code" href="structdcscInitArguments__t.html">TdcscInitArguments</a>));
<a name="l00137"></a>00137     <span class="keywordtype">int</span> <span class="keywordtype">bool</span>=0;
<a name="l00138"></a>00138     <span class="keywordtype">int</span> mmgv=<a class="code" href="memoryguard_8h.html#06fc87d81c62e9abb8790b6e5713c55b9d2980271626aebf61e8867c9fb0ef6a">kmmg_error</a>; <span class="comment">// verbosity of the memory guard</span>
<a name="l00139"></a>00139     <span class="keyword">const</span> <span class="keywordtype">char</span>* mmgf=NULL; <span class="comment">// logfile for the memory guard</span>
<a name="l00140"></a>00140     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> debugFlags=0;
<a name="l00141"></a>00141     <span class="keywordflow">if</span> (<a class="code" href="mrshellprim_8c.html#8f73442602070f02c40b4b3e32ab61a3">mrShellPrimGetInt</a>(<a class="code" href="sendRCUcommand_8c.html#3f74ad6fcd7825c54ac293c30f5c84dc">mainOptions</a>, <span class="stringliteral">"-e"</span>, &amp;<span class="keywordtype">bool</span>)&gt;=0 &amp;&amp; <span class="keywordtype">bool</span>==1) dcscArgs.<a class="code" href="structdcscInitArguments__t.html#75b86ecc9df1bb76dda0c7ee0fcc4f35">flags</a>|=<a class="code" href="group__dcsc__msg__buffer__access.html#g1283f28b3ca2f03f4cfef9a0f8a8ce40">DCSC_INIT_ENCODE</a>; <span class="keywordtype">bool</span>=0;
<a name="l00142"></a>00142     <span class="keywordflow">if</span> (<a class="code" href="mrshellprim_8c.html#8f73442602070f02c40b4b3e32ab61a3">mrShellPrimGetInt</a>(<a class="code" href="sendRCUcommand_8c.html#3f74ad6fcd7825c54ac293c30f5c84dc">mainOptions</a>, <span class="stringliteral">"-a"</span>, &amp;<span class="keywordtype">bool</span>)&gt;=0 &amp;&amp; <span class="keywordtype">bool</span>==1) dcscArgs.<a class="code" href="structdcscInitArguments__t.html#75b86ecc9df1bb76dda0c7ee0fcc4f35">flags</a>|=<a class="code" href="group__dcsc__msg__buffer__access.html#g1bf79fbd2d8c4bcfbed37007a5e9d4b0">DCSC_INIT_APPEND</a>; <span class="keywordtype">bool</span>=0;
<a name="l00143"></a>00143     <span class="keywordflow">if</span> (<a class="code" href="mrshellprim_8c.html#c08c7b1e961204b98f9b29120f043c6c">mrShellPrimGetHex</a>(<a class="code" href="sendRCUcommand_8c.html#3f74ad6fcd7825c54ac293c30f5c84dc">mainOptions</a>, <span class="stringliteral">"--mibsize"</span>, &amp;dcscArgs.<a class="code" href="structdcscInitArguments__t.html#5faecf13bfb7cb86647f13a38d37ccac">iMIBSize</a>)&lt;0) dcscArgs.<a class="code" href="structdcscInitArguments__t.html#5faecf13bfb7cb86647f13a38d37ccac">iMIBSize</a>=0;
<a name="l00144"></a>00144     <span class="keywordflow">if</span> ((iResult=<a class="code" href="mrshellprim_8c.html#c08c7b1e961204b98f9b29120f043c6c">mrShellPrimGetHex</a>(<a class="code" href="sendRCUcommand_8c.html#3f74ad6fcd7825c54ac293c30f5c84dc">mainOptions</a>, <span class="stringliteral">"--debug"</span>, &amp;debugFlags))&gt;=0 &amp;&amp; <a class="code" href="mrshellprim_8h.html#abf55ec262e818b9d10781bbb71f18b1">ARGPROC_EXISTS</a>(iResult)) <a class="code" href="group__dcsc__msg__buffer__access.html#gc07186b103fbe4c39531665c95e22c7e">setDebugOptions</a>(debugFlags);
<a name="l00145"></a>00145     <span class="keywordflow">if</span> ((iResult=<a class="code" href="mrshellprim_8c.html#8f73442602070f02c40b4b3e32ab61a3">mrShellPrimGetInt</a>(<a class="code" href="sendRCUcommand_8c.html#3f74ad6fcd7825c54ac293c30f5c84dc">mainOptions</a>, <span class="stringliteral">"-v"</span>, &amp;dcscArgs.<a class="code" href="structdcscInitArguments__t.html#5ea3b80cc981315aa7508ba54653b57a">iVerbosity</a>))&gt;=0) {
<a name="l00146"></a>00146       <span class="comment">// set the default verbosity if argument not specified</span>
<a name="l00147"></a>00147       <span class="keywordflow">if</span> (<a class="code" href="mrshellprim_8h.html#abf55ec262e818b9d10781bbb71f18b1">ARGPROC_EXISTS</a>(iResult)==0) {
<a name="l00148"></a>00148     <span class="keywordflow">if</span> (argc-iArg&gt;0) dcscArgs.<a class="code" href="structdcscInitArguments__t.html#5ea3b80cc981315aa7508ba54653b57a">iVerbosity</a>=0; <span class="comment">// default verbosity for command line mode</span>
<a name="l00149"></a>00149     <span class="keywordflow">else</span> dcscArgs.<a class="code" href="structdcscInitArguments__t.html#5ea3b80cc981315aa7508ba54653b57a">iVerbosity</a>=1;             <span class="comment">// default verbosity for interactive</span>
<a name="l00150"></a>00150       }
<a name="l00151"></a>00151     }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <span class="keywordflow">if</span> (<a class="code" href="mrshellprim_8c.html#8f73442602070f02c40b4b3e32ab61a3">mrShellPrimGetInt</a>(<a class="code" href="sendRCUcommand_8c.html#3f74ad6fcd7825c54ac293c30f5c84dc">mainOptions</a>, <span class="stringliteral">"--memory-guard-verbosity"</span>, &amp;mmgv)&lt;0) mmgv=<a class="code" href="memoryguard_8h.html#06fc87d81c62e9abb8790b6e5713c55b9d2980271626aebf61e8867c9fb0ef6a">kmmg_error</a>;
<a name="l00155"></a>00155     <span class="keywordflow">if</span> (<a class="code" href="mrshellprim_8c.html#aa038cf5a29f51145c876af7fb5271d3">mrShellPrimGetData</a>(<a class="code" href="sendRCUcommand_8c.html#3f74ad6fcd7825c54ac293c30f5c84dc">mainOptions</a>, <span class="stringliteral">"--memory-guard-logfile"</span>, (<span class="keywordtype">void</span>**)&amp;mmgf, <a class="code" href="mrshellprim_8h.html#76a810650461f2062938ee9b82666b369bf242e7bb183d9518928958c83c9a22">eConstString</a>)&lt;0) mmgf=NULL;
<a name="l00156"></a>00156     <a class="code" href="memoryguard_8h.html#8e4335eedca079f56ff1a72b4c7e567b">mmg_init</a>(mmgf, mmgv);
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     iResult=<a class="code" href="group__dcsc__msg__buffer__access.html#g95f13464dd4da9231a53e7adbb0e7d4e">initRcuAccessExt</a>(pDevice, &amp;dcscArgs);
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 
<a name="l00161"></a>00161     <span class="comment">//initSmAccess(NULL);</span>
<a name="l00162"></a>00162     signal(SIGINT, <a class="code" href="sendRCUcommand_8c.html#47cf995bed43c4e6bc563073f5b8f607">sigquitHandler</a>);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164     <span class="keywordflow">if</span> (iResult&gt;=0){
<a name="l00165"></a>00165       <a class="code" href="mrtimers_8c.html#bf67f427f962506bad53c7ade379249c">initMRTimers</a>(1000000);
<a name="l00166"></a>00166 <span class="preprocessor">#ifdef DCSC_SIMULATION</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span>      <a class="code" href="group__dcsc__msg__buffer__access.html#g0adb3aacb8d7ad32ceabe66a9dcbb401">startSimulation</a>();
<a name="l00168"></a>00168 <span class="preprocessor">#endif //DCSC_SIMULATION</span>
<a name="l00169"></a>00169 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (argc-iArg&gt;0) {
<a name="l00170"></a>00170     <span class="comment">// shell argument mode</span>
<a name="l00171"></a>00171     <span class="keywordflow">if</span> (dcscArgs.<a class="code" href="structdcscInitArguments__t.html#5ea3b80cc981315aa7508ba54653b57a">iVerbosity</a>&gt;=2)
<a name="l00172"></a>00172       fprintf(stderr, <span class="stringliteral">"Command line mode: argc=%d iArg=%d %s\n"</span>, argc, iArg, *(arg+iArg));
<a name="l00173"></a>00173     iResult=<a class="code" href="cmdInterpreter_8c.html#54cbd6e4f4a91310f0c408dc5c6b413d">executeCommandArgs</a>(argc-iArg, (<span class="keyword">const</span> <span class="keywordtype">char</span>**)arg+iArg);
<a name="l00174"></a>00174     <span class="keywordflow">if</span> (iResult==-EINTR) iResult=0; <span class="comment">// -EINTR was used to indicated termination</span>
<a name="l00175"></a>00175       } <span class="keywordflow">else</span> {
<a name="l00176"></a>00176     <span class="comment">// interactive mode</span>
<a name="l00177"></a>00177     <span class="keywordflow">while</span> (cmdBuffer[0]!=<span class="charliteral">'q'</span>) {
<a name="l00178"></a>00178       strcpy(queryBuffer, cmdBuffer);<span class="comment">// the processing of the command may alter the buffer, work on a copy</span>
<a name="l00179"></a>00179       <a class="code" href="cmdInterpreter_8c.html#48086998882e7d163126de4100aa12ac">executeCommandLine</a>(queryBuffer);
<a name="l00180"></a>00180 <span class="preprocessor">#ifdef DCSC_SIMULATION</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span>      <a class="code" href="dcscMsgBufferInterface_8c.html#b54d216419ff2c191363373bef5f9cfa">resetSimulation</a>();
<a name="l00182"></a>00182 <span class="preprocessor">#endif //DCSC_SIMULATION</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span><span class="preprocessor">#ifdef ENABLE_GETLINE</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span>      <span class="keywordtype">char</span>* pInput=<a class="code" href="Getline_8c.html#d4f9d54d023bc30cc8f3e721d81ce386">Getline</a>(<a class="code" href="sendRCUcommand_8c.html#7d71767838ad691171592b8bf69624ad">promt</a>);
<a name="l00185"></a>00185       <a class="code" href="Getline_8c.html#5bc9732aae5850cd5a7b8c7886f3384f">Gl_histadd</a>(pInput);
<a name="l00186"></a>00186       strcpy(queryBuffer, pInput);
<a name="l00187"></a>00187 <span class="preprocessor">#else </span>
<a name="l00188"></a>00188 <span class="preprocessor">      printf(promt);</span>
<a name="l00189"></a>00189 <span class="preprocessor"></span>      gets(queryBuffer);
<a name="l00190"></a>00190 <span class="preprocessor">#endif // ENABLE_GETLINE</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span>      <a class="code" href="mrshellprim_8c.html#e8ed3396fcb78ea4adce3d902b77541a">removePrecAndTrailingSpecChars</a>(queryBuffer);
<a name="l00192"></a>00192       <span class="keywordflow">if</span> (strlen(queryBuffer)==0 || queryBuffer[0]==<span class="charliteral">'a'</span> || queryBuffer[0]==<span class="charliteral">'p'</span>) {
<a name="l00193"></a>00193         printf(<span class="stringliteral">"repeat: %s\n"</span>, cmdBuffer);
<a name="l00194"></a>00194       } <span class="keywordflow">else</span> {
<a name="l00195"></a>00195         strcpy(cmdBuffer, queryBuffer);
<a name="l00196"></a>00196       }
<a name="l00197"></a>00197     }
<a name="l00198"></a>00198       }
<a name="l00199"></a>00199 <span class="preprocessor">#ifdef DCSC_SIMULATION</span>
<a name="l00200"></a>00200 <span class="preprocessor"></span>      <a class="code" href="group__dcsc__msg__buffer__access.html#gd871881385919aff64a8b679984cd018">stopSimulation</a>();
<a name="l00201"></a>00201 <span class="preprocessor">#endif //DCSC_SIMULATION</span>
<a name="l00202"></a>00202 <span class="preprocessor"></span>      <a class="code" href="mrtimers_8c.html#7ce639af18d4674cf8e9ad36b95e76da">releaseMRTimers</a>();  <span class="comment">// cleanup the timers</span>
<a name="l00203"></a>00203       <a class="code" href="group__selectmap__access.html#g75466b7556397eb41108eb84212c5b19">releaseSmAccess</a>();
<a name="l00204"></a>00204       <a class="code" href="group__dcsc__msg__buffer__access.html#gac62a9e57c67af4cb9178b4426ec12fb">releaseRcuAccess</a>(); <span class="comment">// cleanup the msg buffer interface</span>
<a name="l00205"></a>00205     } <span class="keywordflow">else</span> {
<a name="l00206"></a>00206       fprintf(stderr, <span class="stringliteral">"initialisation failed (%d)\n"</span>, iResult);
<a name="l00207"></a>00207     }
<a name="l00208"></a>00208     <a class="code" href="memoryguard_8h.html#77a0d64038440b4c7abafe332d234893">mmg_exit</a>();         <span class="comment">// cleanup the memory guard</span>
<a name="l00209"></a>00209 
<a name="l00210"></a>00210   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iResult!=-EINTR) {
<a name="l00211"></a>00211     fprintf(stderr, <span class="stringliteral">"argument scan failed with %d\n"</span>, iResult);
<a name="l00212"></a>00212   }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214   <span class="keywordflow">if</span> (argc-iArg==0)
<a name="l00215"></a>00215     fprintf(stderr, <span class="stringliteral">"bye, bye\n"</span>);
<a name="l00216"></a>00216   <span class="keywordflow">return</span> iResult;
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 <span class="comment">/* ideas/requests for unit tests</span>
<a name="l00221"></a>00221 <span class="comment">- execute in shell and interactive mode </span>
<a name="l00222"></a>00222 <span class="comment">- execute all commands</span>
<a name="l00223"></a>00223 <span class="comment">- execute command encoding</span>
<a name="l00224"></a>00224 <span class="comment">- check command line options</span>
<a name="l00225"></a>00225 <span class="comment"> */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on 12 Nov 2013 for RCU linux tools and drivers for the DCS board  by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
